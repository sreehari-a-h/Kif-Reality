{% extends 'base.html' %}

{% block title %}Properties - KIF Realty{% endblock %}

{% load static %}

{% block extra_css %}
    <style>
/* Properties Page Specific Styles */
.properties-header {
    margin-top: 10vh;
    background: linear-gradient(135deg, var(--obsidian-black) 0%, var(--charcoal-gray) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-light);
    text-align: center;
    position: relative;
    padding-top: 25px;
    /* margin-bottom: -25px; */
    border-bottom: 1px solid rgba(232, 180, 160, 0.1);
}

/* Mobile adjustments for properties header */
@media (max-width: 768px) {
    .properties-header {
        margin-top: 80px; /* Add margin to prevent navbar overlap */
        height: 50vh; /* Reduce height on mobile */
    }
    
    .header-content h1 {
        font-size: 2.5rem; /* Smaller font on mobile */
    }
    
    .header-content p {
        font-size: 1rem; /* Smaller font on mobile */
    }
}

.properties-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(ellipse at center, rgba(232, 180, 160, 0.1) 0%, transparent 70%);
}

.header-content {
    position: relative;
    z-index: 2;
    max-width: 800px;
    padding: 2rem;
}

.header-content h1 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 4rem;
    margin-bottom: 1rem;
    font-weight: 400;
    background: var(--accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.02em;
}

.header-content p {
    font-size: 1.2rem;
    opacity: 0.9;
    color: var(--text-muted);
    margin-bottom: 1rem;
    font-weight: 300;
}

.total-count {
    background: rgba(232, 180, 160, 0.1);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(232, 180, 160, 0.2);
    padding: 1rem 2rem;
    border-radius: 25px;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--rose-gold);
    display: inline-block;
}

/* Filters Section */
.filters-section {
    background: var(--charcoal-gray);
    padding: 2rem 0;
    /* margin-top: 25px; */
    /* border-radius: 20px 20px 0 0; */
    border: 1px solid rgba(232, 180, 160, 0.1);
    position: relative;
    z-index: 10;
}

.filters-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

.filter-form {
    background: var(--medium-gray);
    padding: 2rem;
    border-radius: 15px;
    border: 1px solid rgba(232, 180, 160, 0.1);
}

/* Property Type Toggle */
.property-type-section {
    margin-bottom: 2rem;
}

.property-type-toggle {
    display: flex;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 15px;
    padding: 0.5rem;
    border: 1px solid rgba(232, 180, 160, 0.2);
}

.property-type-btn {
    flex: 1;
    padding: 12px 20px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.property-type-btn.active {
    background: var(--accent-gradient);
    color: var(--obsidian-black);
    box-shadow: 0 5px 15px rgba(232, 180, 160, 0.4);
}

.property-type-btn:hover:not(.active) {
    background: rgba(232, 180, 160, 0.1);
    color: var(--rose-gold);
}

/* Filter Groups */
.filter-group {
    margin-bottom: 1.5rem;
}

.filter-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--text-light);
    margin-bottom: 0.8rem;
    font-size: 0.95rem;
    letter-spacing: 0.05em;
}

.filter-icon {
    color: var(--rose-gold);
    font-size: 1rem;
}

.filter-select, .filter-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid rgba(232, 180, 160, 0.2);
    border-radius: 10px;
    background: var(--obsidian-black);
    color: var(--text-light);
    font-size: 0.95rem;
    transition: all 0.3s ease;
    font-family: 'Montserrat', sans-serif;
}

.filter-select:focus, .filter-input:focus {
    outline: none;
    border-color: var(--rose-gold);
    box-shadow: 0 0 15px rgba(232, 180, 160, 0.3);
    transform: translateY(-2px);
}

.filter-input::placeholder {
    color: var(--text-muted);
}

/* Main Filters Grid */
.main-filters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* Bedrooms Section */
.bedrooms-section {
    margin-bottom: 2rem;
}

.bedrooms-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
    gap: 0.8rem;
    margin-top: 1rem;
}

.bedroom-btn {
    padding: 12px 16px;
    border: 1px solid rgba(232, 180, 160, 0.2);
    background: var(--obsidian-black);
    color: var(--text-muted);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    font-size: 0.9rem;
}

.bedroom-btn.active {
    background: var(--accent-gradient);
    color: var(--obsidian-black);
    border-color: var(--rose-gold);
    box-shadow: 0 5px 15px rgba(232, 180, 160, 0.4);
}

.bedroom-btn:hover:not(.active) {
    background: rgba(232, 180, 160, 0.1);
    color: var(--rose-gold);
    border-color: var(--rose-gold);
}

/* Advanced Filters */
.advanced-filters-toggle {
    margin-bottom: 1.5rem;
}

.advanced-toggle-btn {
    background: rgba(232, 180, 160, 0.1);
    border: 1px solid rgba(232, 180, 160, 0.2);
    color: var(--rose-gold);
    padding: 12px 20px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    width: 100%;
    justify-content: center;
}

.advanced-toggle-btn:hover {
    background: rgba(232, 180, 160, 0.2);
    transform: translateY(-2px);
}

.advanced-filters-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease;
    border-top: 1px solid rgba(232, 180, 160, 0.1);
    margin-top: 1rem;
    opacity: 0.5;
}

.advanced-filters-content.open {
    max-height: 2000px !important;
    padding-top: 1.5rem;
    opacity: 1;
    transition: max-height 0.5s ease, padding 0.5s ease;
}

.advanced-filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* Range Sliders */
.range-sliders {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.range-group {
    background: rgba(255, 255, 255, 0.05);
    padding: 1.5rem;
    border-radius: 15px;
    border: 1px solid rgba(232, 180, 160, 0.1);
}

.range-inputs {
    position: relative;
    margin: 1rem 0;
}

.range-slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: var(--medium-gray);
    outline: none;
    margin: 1rem 0;
    -webkit-appearance: none;
    appearance: none;
}

.range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent-gradient);
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(232, 180, 160, 0.4);
}

.range-slider::-moz-range-thumb {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: var(--accent-gradient);
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 10px rgba(232, 180, 160, 0.4);
}

.range-display {
    display: flex;
    justify-content: space-between;
    color: var(--text-muted);
    font-size: 0.9rem;
    font-weight: 500;
}

/* Filter Actions */
.filter-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
}

.reset-btn {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(232, 180, 160, 0.2);
    color: var(--text-muted);
    padding: 12px 24px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.reset-btn:hover {
    background: rgba(232, 180, 160, 0.1);
    color: var(--rose-gold);
    transform: translateY(-2px);
}

.search-btn {
    background: var(--accent-gradient);
    color: var(--obsidian-black);
    padding: 12px 24px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.4s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 700;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    position: relative;
    overflow: hidden;
}

.search-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s;
}

.search-btn:hover::before {
    left: 100%;
}

.search-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(232, 180, 160, 0.6);
}

.search-btn.loading {
    pointer-events: none;
    opacity: 0.8;
}

/* Properties Section */
.properties-section {
    max-width: 1600px;
    margin: 0 auto;
    padding: 3rem 1rem;
}

.properties-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.property-card {
    background: linear-gradient(145deg, var(--charcoal-gray), var(--medium-gray));
    border-radius: 20px;
    overflow: hidden;
    border: 1px solid rgba(232, 180, 160, 0.1);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    cursor: pointer;
}

.property-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--accent-gradient);
        opacity: 0;
    transition: opacity 0.5s ease;
    border-radius: 20px;
}

.property-card:hover::before {
    opacity: 0.05;
}

.property-card:hover {
    transform: translateY(-15px) rotateX(5deg);
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.4);
    border-color: rgba(232, 180, 160, 0.3);
}

.property-image {
    height: 250px;
    background-size: cover;
    background-position: center;
    position: relative;
    overflow: hidden;
    background: linear-gradient(45deg, var(--medium-gray), var(--soft-gray));
    display: flex;
    align-items: center;
    justify-content: center;
}

.property-image::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(10,10,10,0.3) 100%);
    transition: all 0.3s ease;
}

.property-card:hover .property-image::before {
    background: linear-gradient(to bottom, transparent 0%, rgba(232, 180, 160, 0.2) 100%);
}

.property-image i {
    font-size: 4rem;
    color: var(--text-muted);
    opacity: 0.3;
    transition: all 0.4s ease;
}

.property-card:hover .property-image i {
    transform: scale(1.2) rotate(10deg);
    color: var(--rose-gold);
    opacity: 0.6;
}

.price-tag {
    position: absolute;
    top: 15px;
    right: 15px;
    background: var(--accent-gradient);
    color: var(--obsidian-black);
    padding: 0.6rem 1.2rem;
    border-radius: 20px;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 5px 15px rgba(232, 180, 160, 0.5);
}

.property-type-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background: rgba(10, 10, 10, 0.9);
    color: var(--rose-gold);
    padding: 0.4rem 1rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: capitalize;
    border: 1px solid rgba(232, 180, 160, 0.2);
    backdrop-filter: blur(10px);
}

.card-body {
    padding: 2rem;
    position: relative;
    z-index: 1;
}

.property-title {
    font-family: 'Cormorant Garamond', serif;
    font-size: 1.6rem;
    font-weight: 600;
    margin-bottom: 0.8rem;
    color: var(--text-light);
    line-height: 1.3;
    letter-spacing: -0.01em;
}

.property-location {
    color: var(--text-muted);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
        gap: 0.5rem;
    font-size: 0.95rem;
    }

.property-location i {
    color: var(--rose-gold);
    }

.property-features {
    display: grid;
    grid-template-columns: 1fr 1fr;
    margin-bottom: 1.5rem;
        padding: 1rem;
    background: rgba(10, 10, 10, 0.3);
    border-radius: 12px;
    border: 1px solid rgba(232, 180, 160, 0.1);
}

.feature-item {
    text-align: center;
    padding: 0.5rem;
}

.feature-icon {
    color: var(--rose-gold);
    font-size: 1.2rem;
    margin-bottom: 0.5rem;
}

.feature-text {
    font-size: 0.9rem;
    color: var(--text-muted);
    font-weight: 500;
}

.property-actions {
    display: grid;
    gap: 0.8rem;
}

.btn-primary-custom {
    background: var(--accent-gradient);
    color: var(--obsidian-black);
    padding: 12px 20px;
    border: none;
    border-radius: 25px;
    font-weight: 700;
    text-decoration: none;
    text-align: center;
    transition: all 0.4s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    position: relative;
    overflow: hidden;
}

.btn-primary-custom::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s;
}

.btn-primary-custom:hover::before {
    left: 100%;
}

.btn-primary-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(232, 180, 160, 0.6);
    color: var(--obsidian-black);
}

.btn-outline-primary {
    background: transparent;
    color: var(--rose-gold);
    padding: 12px 20px;
    border: 2px solid var(--rose-gold);
    border-radius: 25px;
    font-weight: 600;
    text-decoration: none;
    text-align: center;
    transition: all 0.4s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.btn-outline-primary:hover {
    background: var(--rose-gold);
    color: var(--obsidian-black);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(232, 180, 160, 0.4);
}

/* No Properties */
.no-properties {
    text-align: center;
    padding: 4rem 2rem;
    background: var(--charcoal-gray);
    border-radius: 20px;
    border: 1px solid rgba(232, 180, 160, 0.1);
    margin: 2rem 0;
}

.no-properties-icon {
    font-size: 4rem;
    color: var(--rose-gold);
    margin-bottom: 2rem;
    opacity: 0.7;
}

.no-properties h4 {
    font-family: 'Cormorant Garamond', serif;
    font-size: 2rem;
    margin-bottom: 1rem;
            color: var(--text-light);
        }

.no-properties p {
    color: var(--text-muted);
    font-size: 1.1rem;
    margin-bottom: 2rem;
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.6;
}

/* Pagination */
.pagination-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 3rem;
    padding: 2rem;
    background: var(--charcoal-gray);
    border-radius: 20px;
    border: 1px solid rgba(232, 180, 160, 0.1);
}

.pagination-nav {
    display: flex;
    gap: 0.8rem;
}

.page-btn {
    background: var(--medium-gray);
    color: var(--text-light);
    padding: 12px 16px;
    border: 1px solid rgba(232, 180, 160, 0.2);
    border-radius: 50%;
    width: 50px;
    height: 50px;
            cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.9rem;
}

.page-btn:hover, .page-btn.active {
    background: var(--accent-gradient);
    color: var(--obsidian-black);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(232, 180, 160, 0.5);
}

.nav-btn {
    background: var(--rose-gold);
    color: var(--obsidian-black);
    padding: 12px 24px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
            transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.nav-btn:hover {
    background: var(--bright-gold);
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(232, 180, 160, 0.4);
}

.nav-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Error Alert */
.alert-danger {
    background: linear-gradient(135deg, #dc3545, #ff6b6b);
    color: white;
    padding: 1.5rem;
    border-radius: 15px;
    margin-bottom: 2rem;
    border: 1px solid rgba(220, 53, 69, 0.3);
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .header-content h1 {
        font-size: 2.5rem;
    }
    
    .properties-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .filter-form {
        padding: 1.5rem;
    }
    
    .main-filters {
        grid-template-columns: 1fr;
    }
    
    .pagination-section {
        flex-direction: column;
        gap: 1rem;
    }
    
    .pagination-nav {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .properties-header {
        height: 40vh;
    }
    
    .card-body {
        padding: 1.5rem;
    }

    .properties-section {
        padding: 2rem 1rem;
    }
    
    .filter-actions {
        flex-direction: column;
        align-items: center;
    }
    
    .reset-btn, .search-btn {
        width: 100%;
        justify-content: center;
        text-align: center;
        min-height: 48px;
    }
    
    .filter-actions {
        gap: 1rem;
        width: 100%;
    }
    
    .advanced-filters-grid {
        grid-template-columns: 1fr;
    }
    
    .range-sliders {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .properties-section {
        padding: 1.5rem 0.5rem;
    }
    
    .filters-container {
        padding: 0 0.5rem;
    }
    
    .property-image {
        height: 200px;
        background-size: cover;
        background-position: center;
    }
    
    .property-title {
        font-size: 1.4rem;
    }

    .header-content {
        padding: 1rem;
    }

    .header-content h1 {
        font-size: 2rem;
    }
        }
    </style>
{% endblock %}

{% load custom_filters %}

{% block content %}

<!-- Page Header -->
<section class="properties-header">
        <div class="header-content">
            <h1>Signature Collection</h1>
            <p>Discover exceptional real estate opportunities in prime locations</p>
            <div class="total-count">
                <i class="fas fa-gem me-2"></i>
                <strong>{{ total_count }}</strong> Exclusive Properties Available
        </div>
    </div>
</section>

<!-- Filters Section -->
<section class="filters-section">
    <div class="filters-container">
        <form method="POST" class="filter-form" action="{% url 'properties' %}">
            {% csrf_token %}
            
            <!-- Property Type Toggle -->
            <div class="property-type-section">
                <label class="filter-label">Property Type</label>
                <div class="property-type-toggle">
                                    <button type="button" class="property-type-btn active" data-type="residential" id="residentialBtn">
                        Residential
                    </button>
                <button type="button" class="property-type-btn" data-type="commercial" id="commercialBtn">
                        Commercial
                    </button>
                </div>
                <input type="hidden" name="property_type" id="propertyTypeInput" value="residential">
            </div>

            <!-- Main Filters Grid -->
            <div class="main-filters">
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-home filter-icon"></i>
                        Unit Type
                    </label>
                    <select name="unit_type" class="filter-select" id="unitTypeSelect">
                        <option value="">All Types</option>
                        <option value="apartment">Apartment</option>
                        <option value="villa">Villa</option>
                        <option value="townhouse">Townhouse</option>
                        <option value="penthouse">Penthouse</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-map-marker-alt filter-icon"></i>
                        City
                    </label>
                    <select name="city" class="filter-select" id="citySelect">
                        <option value="">All Cities</option>
                        <!-- Cities will be populated from API -->
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-building filter-icon"></i>
                        Neighborhood
                    </label>
                    <select name="district" class="filter-select" id="neighborhoodSelect">
                        <option value="">Select Area</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-dollar-sign filter-icon"></i>
                        Price Range
                    </label>
                    <select name="price_range" class="filter-select">
                        <option value="">Any Price</option>
                        <option value="0-1000000">Under 1M AED</option>
                        <option value="1000000-2000000">1M - 2M AED</option>
                        <option value="2000000-5000000">2M - 5M AED</option>
                        <option value="5000000-10000000">5M - 10M AED</option>
                        <option value="10000000+">Above 10M AED</option>
                    </select>
                </div>
            </div>

            <!-- Bedrooms Section (Only for Residential) -->
            <div class="bedrooms-section" id="bedroomsSection">
                <label class="filter-label">
                    <i class="fas fa-bed filter-icon"></i>
                    Bedrooms
                </label>
                <div class="bedrooms-grid">
                    <button type="button" class="bedroom-btn" data-bedrooms="1">1</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="2">2</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="3">3</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="4">4</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="5">5</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="6+">6+</button>
                </div>
                <input type="hidden" name="bedrooms" id="bedroomsInput" value="">
            </div>

            <!-- Advanced Filters Toggle -->
            <div class="advanced-filters-toggle">
                <button type="button" class="advanced-toggle-btn" id="advancedToggle">
                    <i class="fas fa-sliders-h"></i>
                Advanced Filters
                    <i class="fas fa-chevron-down" id="advancedIcon"></i>
            </button>
            </div>

            <!-- Advanced Filters Content -->
            <div class="advanced-filters-content" id="advancedContent">
                <div class="advanced-filters-grid">
                        <div class="filter-group">
                            <label class="filter-label">
                            <i class="fas fa-calendar filter-icon"></i>
                            Delivery Year
                            </label>
                        <select name="delivery_year" class="filter-select">
                            <option value="">Any Year</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                        </div>
                        
                        <div class="filter-group">
                            <label class="filter-label">
                            <i class="fas fa-building filter-icon"></i>
                                Developer
                            </label>
                        <select name="developer" class="filter-select" id="developerSelect">
                                <option value="">All Developers</option>
                            <!-- Developers will be populated from API -->
                            </select>
                    </div>

                        <div class="filter-group">
                            <label class="filter-label">
                            <i class="fas fa-search filter-icon"></i>
                            Project Name
                            </label>
                        <input type="text" name="project_name" class="filter-input" placeholder="Search by project name">
                        </div>

                        <div class="filter-group">
                            <label class="filter-label">
                            <i class="fas fa-tag filter-icon"></i>
                            Property Status
                            </label>
                        <select name="property_status" class="filter-select">
                            <option value="">Any Status</option>
                            <option value="Ready">Ready</option>
                            <option value="Off Plan">Off Plan</option>
                            <option value="Under Construction">Under Construction</option>
                            </select>
                        </div>
                    </div>

                <!-- Price Range Sliders -->
                <div class="range-sliders">
                    <div class="range-group">
                        <label class="filter-label">
                            <i class="fas fa-coins filter-icon"></i>
                                Price Range (AED)
                        </label>
                        <div class="range-inputs">
                            <input type="range" id="minPriceRange" min="0" max="100000000" value="0" class="range-slider">
                            <input type="range" id="maxPriceRange" min="0" max="100000000" value="100000000" class="range-slider">
                            </div>
                        <div class="range-display">
                            <span id="minPriceDisplay">0 AED</span>
                            <span id="maxPriceDisplay">100M AED</span>
                                    </div>
                        <input type="hidden" name="min_price" id="minPriceInput" value="0">
                        <input type="hidden" name="max_price" id="maxPriceInput" value="100000000">
                        </div>

                    <div class="range-group">
                        <label class="filter-label">
                                <i class="fas fa-ruler-combined filter-icon"></i>
                                Area Range (sq ft)
                            </label>
                        <div class="range-inputs">
                            <input type="range" id="minAreaRange" min="0" max="50000" value="0" class="range-slider">
                            <input type="range" id="maxAreaRange" min="0" max="50000" value="50000" class="range-slider">
                        </div>
                        <div class="range-display">
                            <span id="minAreaDisplay">0 sq ft</span>
                            <span id="maxAreaDisplay">50,000 sq ft</span>
                        </div>
                        <input type="hidden" name="min_area" id="minAreaInput" value="0">
                        <input type="hidden" name="max_area" id="maxAreaInput" value="50000">
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="filter-actions">
                <button type="button" class="reset-btn" onclick="resetFilters()">
                    <i class="fas fa-refresh"></i>
                    Reset Filters
                </button>
                <button type="submit" class="search-btn" id="searchBtn">
                    <i class="fas fa-search"></i>
                    Search Properties
                </button>
            </div>
        </form>
    </div>
</section>

<!-- Properties Grid -->
<section class="properties-section">
    {% if properties_error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        {{ properties_error }}
    </div>
    {% endif %}

    <div class="properties-grid">
        {% for property in properties %}
        <div class="property-card">
            <div class="property-image" {% if property.image %}style="background-image: url('{{ property.image }}');"{% endif %}>
                {% if property.image %}
                {% else %}
                <i class="fas fa-crown"></i>
                {% endif %}
                <div class="price-tag">
                    Available
                    {% if property.price %}
                    <!-- AED {{ property.low_price|floatformat:0|add_commas }} -->
                    {% else %}
                    <!-- Contact for Price -->
                    {% endif %}
                </div>
                <div class="property-type-badge">
                    {{ property.property_type|default:"Residential" }}
                </div>
            </div>

            <div class="card-body">
                <h3 class="property-title">{{ property.title|default:"Luxury Property" }}</h3>
                
                <div class="property-location">
                    <i class="fas fa-map-marker-alt"></i>
                    {{ property.location|default:"Premium Location, Dubai" }}
                </div>

                <div class="property-features">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-bed"></i>
                        </div>
                        <div class="feature-text">{{ property.bedrooms|default:"N/A" }} Bedrooms</div>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-ruler-combined"></i>
                        </div>
                        <div class="feature-text">{{ property.area|default:"N/A" }} sq ft</div>
                    </div>
                </div>

                <div class="property-actions">
                    <a href="{% url 'property_detail' property.id %}" class="btn-primary-custom">
                        <i class="fas fa-eye"></i>
                        View Details
                    </a>
                    <a href="{% url 'contact' %}" class="btn-outline-primary">
                        <i class="fas fa-phone"></i>
                        Contact Agent
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="no-properties">
            <div class="no-properties-icon">
                <i class="fas fa-search"></i>
            </div>
            <h4>No Properties Found</h4>
            <p>We couldn't find any properties matching your criteria. Try adjusting your search filters or explore our complete collection of luxury properties.</p>
            <a href="{% url 'properties' %}" class="btn-primary-custom" style="display: inline-flex;">
                <i class="fas fa-refresh me-2"></i>
                View All Properties
            </a>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if next_page or prev_page %}
    <div class="pagination-section">
        <!-- Previous Button -->
        {% if prev_page %}
        <button type="button" class="nav-btn" onclick="goToPage('{{ prev_page }}')">
            <i class="fas fa-chevron-left"></i>
            Previous
        </button>
        {% else %}
        <span></span>
        {% endif %}

        <!-- Page Numbers -->
        {% if last_page > 1 %}
        <div class="pagination-nav">
            {% for i in page_range %}
                {% if i == '...' %}
                    <span class="page-btn" style="cursor: default;">...</span>
                {% else %}
                    <button type="button" class="page-btn {% if i == current_page %}active{% endif %}" onclick="goToPage('{{ i }}')">
                        {{ i }}
                    </button>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Next Button -->
        {% if next_page %}
        <button type="button" class="nav-btn" onclick="goToPage('{{ next_page }}')">
            Next
            <i class="fas fa-chevron-right"></i>
        </button>
        {% else %}
        <span></span>
        {% endif %}
    </div>
    {% endif %}
</section>

{% block extra_js %}
<script>
// Global helper function for CSRF token - must be defined first
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

(function() {
    // Enhanced Filter Functionality - Wrapped in IIFE to prevent variable conflicts
    
    // Use a more specific global check to prevent double initialization
    if (window.filterSystemInitialized) {
        console.log('‚ö†Ô∏è Filter system already initialized, skipping...');
        return;
    }
    
    window.filterSystemInitialized = true;
    console.log('‚úÖ Initializing filter system...');

document.addEventListener('DOMContentLoaded', function() {
        console.log('üìã DOMContentLoaded fired');
    initializeFilters();
    setupEventListeners();
});

function initializeFilters() {
    console.log('üîß Initializing filters...');
    
    // Set default property type to residential
    const propertyTypeInput = document.getElementById('propertyTypeInput');
    if (propertyTypeInput) {
        propertyTypeInput.value = 'residential';
    }
    
    // Update visual state to show residential as active
    updatePropertyType('residential');
    
    // Ensure residential button is active by default
    const residentialBtn = document.getElementById('residentialBtn');
    const commercialBtn = document.getElementById('commercialBtn');
    
    if (residentialBtn && commercialBtn) {
        residentialBtn.classList.add('active');
        commercialBtn.classList.remove('active');
        console.log('üè† Set residential as default property type');
    }
    
    // Initialize ranges
    updatePriceRange();
    updateAreaRange();
    
    // Load cities and developers from API
    loadCitiesFromAPI();
    loadDevelopersFromAPI();
}

function setupEventListeners() {
    // Property type toggle
    document.querySelectorAll('.property-type-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent any form submission
            e.stopPropagation(); // Stop event bubbling
            
            const type = this.dataset.type;
            updatePropertyType(type);
            // Don't auto-search on property type change - let user click search button
        });
    });

    // Bedrooms
    document.querySelectorAll('.bedroom-btn').forEach(btn => {
        console.log('üõèÔ∏è Setting up bedroom button:', btn.dataset.bedrooms);
        
        // Remove existing listeners to prevent duplicates
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            e.stopPropagation(); // Stop event bubbling
            
            const bedrooms = this.dataset.bedrooms;
            console.log('üõèÔ∏è Bedroom button clicked:', bedrooms);
            updateBedroomSelection(bedrooms);
        });
    });

    // Advanced filters toggle
    const advancedToggle = document.getElementById('advancedToggle');
    console.log('üîΩ Setting up advanced toggle - element found:', !!advancedToggle);
    if (advancedToggle) {
        advancedToggle.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent form submission
            e.stopPropagation(); // Stop event bubbling
            console.log('üîΩ Advanced toggle clicked');
            toggleAdvancedFilters();
        });
        console.log('‚úÖ Advanced toggle event listener attached');
    } else {
        console.error('‚ùå Advanced toggle button not found!');
    }

                // Form submission with loading state - Only update properties section
    const filterForm = document.querySelector('.filter-form');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            e.preventDefault(); // Prevent default form submission
            
        const searchBtn = document.getElementById('searchBtn');
            
            // Prevent multiple submissions if already loading
            if (searchBtn.classList.contains('loading')) {
                console.log('üîç Search already in progress, ignoring...');
                return;
            }
            
            console.log('üîç Form submitted - starting search...');
        const originalText = searchBtn.innerHTML;
        
        searchBtn.classList.add('loading');
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
            searchBtn.disabled = true;
        
            // Collect form data and make API call
            handleSearch().finally(() => {
                // Reset button state after search completes
            searchBtn.classList.remove('loading');
            searchBtn.innerHTML = originalText;
                searchBtn.disabled = false;
    });
        });
    }
    
    // Search button is type="submit" so it will automatically trigger form submission

    // City change handler
    document.getElementById('citySelect').addEventListener('change', function() {
        updateNeighborhoods(this.value);
    });

    // Range slider event listeners
    const minPriceRange = document.getElementById('minPriceRange');
    const maxPriceRange = document.getElementById('maxPriceRange');
    const minAreaRange = document.getElementById('minAreaRange');
    const maxAreaRange = document.getElementById('maxAreaRange');

    if (minPriceRange && maxPriceRange) {
        minPriceRange.addEventListener('input', updatePriceRange);
        maxPriceRange.addEventListener('input', updatePriceRange);
    }

    if (minAreaRange && maxAreaRange) {
        minAreaRange.addEventListener('input', updateAreaRange);
        maxAreaRange.addEventListener('input', updateAreaRange);
    }
}

function updatePropertyTypeVisual(type) {
    // Update buttons with proper state management (visual only)
    const residentialBtn = document.getElementById('residentialBtn');
    const commercialBtn = document.getElementById('commercialBtn');
    
    if (residentialBtn && commercialBtn) {
        if (type === 'residential') {
            residentialBtn.classList.add('active');
            commercialBtn.classList.remove('active');
        } else {
            residentialBtn.classList.remove('active');
            commercialBtn.classList.add('active');
        }
    }
    
    // Update unit type options and bedrooms section visibility
    updateUnitTypeOptions(type);
}

function updatePropertyType(type) {
    // Update visual state
    updatePropertyTypeVisual(type);

    // Update hidden input
    const propertyTypeInput = document.getElementById('propertyTypeInput');
    if (propertyTypeInput) {
        propertyTypeInput.value = type;
    }
}

function updateUnitTypeOptions(type) {
    const unitTypeSelect = document.getElementById('unitTypeSelect');
    const currentValue = unitTypeSelect ? unitTypeSelect.value : '';
    if (unitTypeSelect) {
    unitTypeSelect.innerHTML = '<option value="">All Types</option>';
    }

    const bedroomsSection = document.getElementById('bedroomsSection');

    if (type === 'commercial') {
        const commercialOptions = [
            { value: 'office', text: 'Office' },
            { value: 'shop', text: 'Shop' },
            { value: 'warehouse', text: 'Warehouse' },
            { value: 'retail', text: 'Retail Space' },
            { value: 'showroom', text: 'Showroom' },
            { value: 'restaurant', text: 'Restaurant' }
        ];
        
        commercialOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            if (currentValue === option.value) {
                optionElement.selected = true;
            }
            if (unitTypeSelect) {
            unitTypeSelect.appendChild(optionElement);
            }
        });

        if (bedroomsSection) {
            bedroomsSection.style.display = 'none';
        }
    } else {
        const residentialOptions = [
            { value: 'apartment', text: 'Apartment' },
            { value: 'villa', text: 'Villa' },
            { value: 'townhouse', text: 'Townhouse' },
            { value: 'penthouse', text: 'Penthouse' },
            { value: 'studio', text: 'Studio' },
            { value: 'duplex', text: 'Duplex' }
        ];
        
        residentialOptions.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option.value;
            optionElement.textContent = option.text;
            if (currentValue === option.value) {
                optionElement.selected = true;
            }
            if (unitTypeSelect) {
            unitTypeSelect.appendChild(optionElement);
            }
        });

        if (bedroomsSection) {
            bedroomsSection.style.display = 'block';
        }
    }
}

function updateBedroomSelection(bedrooms) {
    // Remove active class from all buttons
    document.querySelectorAll('.bedroom-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // Update hidden input
    const bedroomsInput = document.getElementById('bedroomsInput');
    if (bedroomsInput) {
        // If clicking the same bedroom button, deselect it
        if (bedroomsInput.value === bedrooms) {
            bedroomsInput.value = '';
            console.log('üõèÔ∏è Deselected bedrooms');
        } else {
            // Otherwise, select the new bedroom count
            bedroomsInput.value = bedrooms;
            // Add active class to the selected button
            const selectedBtn = document.querySelector(`[data-bedrooms="${bedrooms}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active');
            }
            console.log('üõèÔ∏è Selected bedrooms:', bedrooms);
        }
    }
}

function toggleAdvancedFilters() {
    console.log('üîΩ toggleAdvancedFilters called');
    const content = document.getElementById('advancedContent');
    const icon = document.getElementById('advancedIcon');
    
    console.log('üîΩ Elements found - content:', !!content, 'icon:', !!icon);
    
    if (!content || !icon) {
        console.error('‚ùå Advanced filter elements not found!');
        return;
    }
    
    const isOpen = content.classList.contains('open');
    console.log('üîΩ Current state before toggle - isOpen:', isOpen);
    console.log('üîΩ Content classes before:', content.className);

    if (isOpen) {
        content.classList.remove('open');
        content.style.maxHeight = '0px';
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        console.log('üîΩ CLOSING advanced filters');
        console.log('üîΩ Content classes after close:', content.className);
    } else {
        content.classList.add('open');
        content.style.maxHeight = '2000px';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        console.log('üîΩ OPENING advanced filters');
        console.log('üîΩ Content classes after open:', content.className);
    }
    
    // Log final state
    setTimeout(() => {
        console.log('üîΩ Final state after 100ms - isOpen:', content.classList.contains('open'));
        console.log('üîΩ Content computed height:', window.getComputedStyle(content).height);
        console.log('üîΩ Content max-height:', window.getComputedStyle(content).maxHeight);
    }, 100);
}

function updatePriceRange() {
    const minRange = document.getElementById('minPriceRange');
    const maxRange = document.getElementById('maxPriceRange');
    const minDisplay = document.getElementById('minPriceDisplay');
    const maxDisplay = document.getElementById('maxPriceDisplay');
    const minInput = document.getElementById('minPriceInput');
    const maxInput = document.getElementById('maxPriceInput');

    if (!minRange || !maxRange) return;

    let minVal = parseInt(minRange.value);
    let maxVal = parseInt(maxRange.value);

    // Ensure min doesn't exceed max
    if (minVal >= maxVal) {
        minVal = maxVal - 100000;
        minRange.value = minVal;
    }

    // Format and display values
    if (minDisplay) minDisplay.textContent = formatCurrency(minVal);
    if (maxDisplay) maxDisplay.textContent = formatCurrency(maxVal);
    if (minInput) minInput.value = minVal;
    if (maxInput) maxInput.value = maxVal;
}

function updateAreaRange() {
    const minRange = document.getElementById('minAreaRange');
    const maxRange = document.getElementById('maxAreaRange');
    const minDisplay = document.getElementById('minAreaDisplay');
    const maxDisplay = document.getElementById('maxAreaDisplay');
    const minInput = document.getElementById('minAreaInput');
    const maxInput = document.getElementById('maxAreaInput');

    if (!minRange || !maxRange) return;

    let minVal = parseInt(minRange.value);
    let maxVal = parseInt(maxRange.value);

    // Ensure min doesn't exceed max
    if (minVal >= maxVal) {
        minVal = maxVal - 100;
        minRange.value = minVal;
    }

    // Format and display values
    if (minDisplay) minDisplay.textContent = minVal.toLocaleString() + ' sq ft';
    if (maxDisplay) maxDisplay.textContent = maxVal.toLocaleString() + ' sq ft';
    if (minInput) minInput.value = minVal;
    if (maxInput) maxInput.value = maxVal;
}

function formatCurrency(num) {
    if (num === 0) return '0 AED';
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M AED';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(0) + 'K AED';
    }
    return num.toLocaleString() + ' AED';
}

// Global variable to store cities data
let citiesData = [];

// Global variable to store developers data
let developersData = [];

function loadCitiesFromAPI() {
    fetch('/cities/')
        .then(response => response.json())
        .then(result => {
            // Handle the nested structure: result.data.data
            if (result && result.data && result.data.status && result.data.data) {
                citiesData = result.data.data;
                populateCitiesDropdown();
            } else {
                console.error('Failed to load cities:', result.error || 'Invalid response structure');
                // Fallback to no cities if API fails
                citiesData = [];
            }
        })
        .catch(error => {
            console.error('Error loading cities:', error);
            // Fallback to no cities if API fails
            citiesData = [];
        });
}

function populateCitiesDropdown() {
    const citySelect = document.getElementById('citySelect');
    
    if (!citySelect) {
        console.error('‚ùå City select element not found');
        return;
    }
    
    if (!citiesData.length) {
        console.error('‚ùå No cities data available');
        return;
    }
    
    // Clear existing options except the first one
    citySelect.innerHTML = '<option value="">All Cities</option>';
    
    // Add cities from API - Use a Set to avoid duplicates
    const uniqueCities = new Map();
    citiesData.forEach(city => {
        if (city.name && city.name.en) {
            uniqueCities.set(city.name.en, city);
        }
    });
    
    // Add unique cities to dropdown
    uniqueCities.forEach((city, cityName) => {
        const option = document.createElement('option');
        option.value = cityName; // Use English name as value
        option.textContent = cityName; // Display English name
        citySelect.appendChild(option);
    });
}

function loadDevelopersFromAPI() {
    console.log('üèóÔ∏è Loading developers from API...');
    fetch('https://offplan.market/api/developers/')
        .then(response => {
            console.log('üèóÔ∏è Developers API response status:', response.status);
            return response.json();
        })
        .then(result => {
            console.log('üèóÔ∏è Developers API response:', result);
            console.log('üèóÔ∏è Response structure check:', {
                hasResult: !!result,
                hasStatus: result && result.status,
                hasData: result && result.data,
                isArray: result && result.data && Array.isArray(result.data),
                dataLength: result && result.data ? result.data.length : 'no data'
            });
            
            // Handle the API response structure - external API might have different structure
            console.log('üèóÔ∏è Full API response structure:', result);
            
            // Try different possible response structures
            let developers = null;
            
            if (result && Array.isArray(result)) {
                // Direct array response
                developers = result;
            } else if (result && result.data && Array.isArray(result.data)) {
                // Nested data structure
                developers = result.data;
            } else if (result && result.status && result.data && Array.isArray(result.data)) {
                // Status + data structure
                developers = result.data;
            }
            
            if (developers && developers.length > 0) {
                developersData = developers;
                console.log('üèóÔ∏è Developers data loaded:', developersData);
                populateDevelopersDropdown();
            } else {
                console.error('Failed to load developers - no valid data found');
                console.error('Result details:', result);
                // Fallback to no developers if API fails
                developersData = [];
            }
        })
        .catch(error => {
            console.error('Error loading developers:', error);
            // Fallback to no developers if API fails
            developersData = [];
        });
}

function populateDevelopersDropdown() {
    const developerSelect = document.getElementById('developerSelect');
    
    if (!developerSelect) {
        console.error('‚ùå Developer select element not found');
        return;
    }
    
    if (!developersData.length) {
        console.error('‚ùå No developers data available');
        return;
    }
    
    // Clear existing options except the first one
    developerSelect.innerHTML = '<option value="">All Developers</option>';
    
    // Add developers from API - Use a Set to avoid duplicates
    const uniqueDevelopers = new Map();
    developersData.forEach(developer => {
        // Handle different possible developer object structures
        let developerName = null;
        
        if (typeof developer === 'string') {
            // Direct string value
            developerName = developer;
        } else if (developer && developer.name) {
            // Object with name property
            developerName = developer.name;
        } else if (developer && developer.title) {
            // Object with title property
            developerName = developer.title;
        } else if (developer && developer.id) {
            // Object with id, try to use id as name
            developerName = developer.id;
        }
        
        if (developerName) {
            uniqueDevelopers.set(developerName, developer);
        }
    });
    
    // Sort developers alphabetically and add to dropdown
    const sortedDevelopers = Array.from(uniqueDevelopers.entries()).sort((a, b) => a[0].localeCompare(b[0]));
    
    sortedDevelopers.forEach(([developerName, developer]) => {
        const option = document.createElement('option');
        option.value = developerName; // Use developer name as value
        option.textContent = developerName; // Display developer name
        developerSelect.appendChild(option);
    });
    
    console.log('üèóÔ∏è Developers dropdown populated with', uniqueDevelopers.size, 'developers');
    console.log('üèóÔ∏è Developer names:', Array.from(uniqueDevelopers.keys()));
}

function updateNeighborhoods(cityName) {
    console.log('üèòÔ∏è Updating neighborhoods for city:', cityName);
    const neighborhoodSelect = document.getElementById('neighborhoodSelect');
    
    if (!neighborhoodSelect) {
        console.error('‚ùå Neighborhood select element not found');
        return;
    }
    
    // Store current value
    const currentValue = neighborhoodSelect.value;
    
    // Clear existing options
    neighborhoodSelect.innerHTML = '<option value="">Select Area</option>';
    
    if (!cityName || !citiesData.length) {
        console.log('üèòÔ∏è No city selected or no cities data available');
        return;
    }
    
    // Find all cities with the selected name (there might be duplicates)
    const matchingCities = citiesData.filter(city => city.name && city.name.en === cityName);
    console.log('üèòÔ∏è Found', matchingCities.length, 'matching cities for', cityName);
    
    if (matchingCities.length === 0) {
        console.log('üèòÔ∏è No matching cities found');
        return;
    }
    
    // Collect all districts from all matching cities and remove duplicates
    const allDistricts = new Map();
    
    matchingCities.forEach(city => {
        if (city.districts && city.districts.length > 0) {
            console.log('üèòÔ∏è City', cityName, 'has', city.districts.length, 'districts');
            city.districts.forEach(district => {
                if (district.name && district.name.en) {
                    allDistricts.set(district.name.en, district);
                }
            });
        }
    });
    
    console.log('üèòÔ∏è Total unique districts found:', Array.from(allDistricts.keys()));
    
    // Add districts to dropdown
    if (allDistricts.size > 0) {
        // Sort districts alphabetically
        const sortedDistricts = Array.from(allDistricts.entries()).sort((a, b) => a[0].localeCompare(b[0]));
        
        sortedDistricts.forEach(([districtName, district]) => {
            const option = document.createElement('option');
            option.value = districtName; // Use English name as value
            option.textContent = districtName; // Display English name
            if (currentValue === option.value) {
                option.selected = true;
            }
            neighborhoodSelect.appendChild(option);
        });
        
        console.log('üèòÔ∏è Neighborhoods dropdown populated with', allDistricts.size, 'districts');
    } else {
        console.log('üèòÔ∏è No districts found for city:', cityName);
    }
}

function resetFilters() {
    // Reset the form
    const filterForm = document.querySelector('.filter-form');
    if (filterForm) {
        filterForm.reset();
    }
    
    // Reset property type to residential
    updatePropertyType('residential');
    
    // Reset bedroom selections
    document.querySelectorAll('.bedroom-btn').forEach(btn => btn.classList.remove('active'));
    const bedroomsInput = document.getElementById('bedroomsInput');
    if (bedroomsInput) bedroomsInput.value = '';
    
    // Reset ranges
    const minPriceRange = document.getElementById('minPriceRange');
    const maxPriceRange = document.getElementById('maxPriceRange');
    const minAreaRange = document.getElementById('minAreaRange');
    const maxAreaRange = document.getElementById('maxAreaRange');
    
    if (minPriceRange) minPriceRange.value = 0;
    if (maxPriceRange) maxPriceRange.value = 100000000;
    if (minAreaRange) minAreaRange.value = 0;
    if (maxAreaRange) maxAreaRange.value = 50000;
    
    updatePriceRange();
    updateAreaRange();
    
    // Reset dropdowns
    const neighborhoodSelect = document.getElementById('neighborhoodSelect');
    if (neighborhoodSelect) {
        neighborhoodSelect.innerHTML = '<option value="">Select Area</option>';
    }
    
    // Reload cities and developers from API
    loadCitiesFromAPI();
    loadDevelopersFromAPI();
    
    // Close advanced filters
    const content = document.getElementById('advancedContent');
    const icon = document.getElementById('advancedIcon');
    if (content && icon) {
        content.classList.remove('open');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
    
    // Visual feedback
    const resetBtn = document.querySelector('.reset-btn');
    if (resetBtn) {
        const originalText = resetBtn.innerHTML;
        resetBtn.innerHTML = '<i class="fas fa-check"></i> Reset Complete';
        
        setTimeout(() => {
            resetBtn.innerHTML = originalText;
        }, 1500);
    }
    
    // Don't auto-trigger search after reset - let user click search button
}

// Debounce search to prevent multiple rapid calls
let searchTimeout = null;

function handleSearch() {
    // Clear any existing timeout
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }
    
    // Return a promise that resolves when search is complete
    return new Promise((resolve) => {
        // Add small delay to prevent rapid-fire requests
        searchTimeout = setTimeout(() => {
            performSearch().then(resolve).catch(resolve);
        }, 100);
    });
}

function performSearch() {
    
    // Collect form data from the actual form
    const filterForm = document.querySelector('.filter-form');
    const formData = new FormData(filterForm);
    
    // Get property type value and convert to match React format
    const propertyTypeValue = formData.get('property_type') || 'residential';
    let propertyTypeText = 'Residential'; // Default to Residential
    if (propertyTypeValue === 'commercial') {
        propertyTypeText = 'Commercial'; // Match React format
    } else if (propertyTypeValue === 'residential') {
        propertyTypeText = 'Residential'; // Match React format
    }
    
    // Debug log to check what property type is being sent
    console.log('üîç Frontend property type being sent:', {
        formValue: propertyTypeValue,
        apiValue: propertyTypeText
    });
    
    const filters = {};
    
    // Always include property_type (Required: Residential or Commercial)
    filters.property_type = propertyTypeText;
    
    // Only add non-empty string values
    const city = formData.get('city');
    if (city && city.trim()) {
        filters.city = city.trim();
    }
    
    const district = formData.get('district');
    if (district && district.trim()) {
        filters.district = district.trim();
    }
    
    const unitType = formData.get('unit_type');
    if (unitType && unitType.trim()) {
        filters.unit_type = unitType.trim();
    }
    
    // Only send rooms for Residential and if selected
    if (propertyTypeText === 'Residential') {
        const rooms = formData.get('bedrooms');
        if (rooms && rooms.trim()) {
            filters.rooms = rooms.trim();
        }
    }
    
    // Only add delivery_year if explicitly selected (not default)
    const deliveryYear = formData.get('delivery_year');
    if (deliveryYear && deliveryYear.trim() && deliveryYear !== '0') {
        filters.delivery_year = parseInt(deliveryYear);
    }
    
    // Only add price range if modified from defaults
    const minPrice = parseInt(formData.get('min_price')) || 0;
    const maxPrice = parseInt(formData.get('max_price')) || 100000000;
    if (minPrice > 0) {
        filters.low_price = minPrice;
    }
    if (maxPrice < 100000000) {
        filters.max_price = maxPrice;
    }
    
    // Only add area range if modified from defaults
    const minArea = parseInt(formData.get('min_area')) || 0;
    const maxArea = parseInt(formData.get('max_area')) || 50000;
    if (minArea > 0) {
        filters.min_area = minArea;
    }
    if (maxArea < 50000) {
        filters.max_area = maxArea;
    }
    
    // Only add if provided
    const title = formData.get('project_name');
    if (title && title.trim()) {
        filters.title = title.trim();
    }
    
    const developer = formData.get('developer');
    if (developer && developer.trim()) {
        filters.developer = developer.trim();
    }
    
    // Add property_status conditionally like React does
    const propertyStatus = formData.get('property_status');
    if (propertyStatus && propertyStatus.trim() && propertyStatus !== 'Total') {
        filters.property_status = propertyStatus.trim();
    }
    
    console.log('üîç Sending filters:', filters);

    // Make API call and return Promise
    const csrftoken = getCookie('csrftoken');
    return fetch('/api/properties/filter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        credentials: 'include',
        body: JSON.stringify(filters),
    })
    .then(response => response.json())
    .then(result => {
        console.log('üè† Properties API response:', result);
        
        if (result?.status && result?.data) {
            // Handle the correct API response structure
            const propertiesData = result.data;
            const properties = propertiesData.results || [];
            
            console.log('üè† Found', properties.length, 'properties');
            console.log('üè† Total count:', propertiesData.count);
            
            // Always update the grid, even if empty (it will show "no properties" message)
            updatePropertiesGrid(properties);
            updatePagination(propertiesData);
            updateTotalCount(propertiesData.count || 0);
        } else {
            console.error('‚ùå Properties API error:', result?.error || result?.message || 'No properties found');
            // Show empty properties grid instead of error
            updatePropertiesGrid([]);
            updatePagination({count: 0, current_page: 1, last_page: 1});
            updateTotalCount(0);
        }
    })
    .catch(error => {
        console.error('‚ùå Search error:', error);
        showError('An error occurred while searching properties');
        throw error; // Re-throw to ensure promise rejection is handled
    });
}



// Global function to update properties grid
function updatePropertiesGrid(properties) {
    const propertiesGrid = document.querySelector('.properties-grid');
    if (!propertiesGrid) return;

    if (properties.length === 0) {
        propertiesGrid.innerHTML = `
            <div class="no-properties">
                <div class="no-properties-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h4>No Properties Found</h4>
                <p>We couldn't find any properties matching your criteria. Try adjusting your search filters or explore our complete collection of luxury properties.</p>
                <a href="{% url 'properties' %}" class="btn-primary-custom" style="display: inline-flex;">
                    <i class="fas fa-refresh me-2"></i>
                    View All Properties
                </a>
            </div>
        `;
        return;
    }

    const propertiesHTML = properties.map(property => {
        // Map property type - the backend already sends the correct text
        let propertyTypeText = property.property_type || 'Residential';
        
        // If it's still a number, convert it (fallback)
        if (propertyTypeText === 3 || propertyTypeText === '3') {
            propertyTypeText = 'Commercial';
        } else if (propertyTypeText === 20 || propertyTypeText === '20') {
            propertyTypeText = 'Residential';
        }
        
        // Debug log to check what property type is being received
        console.log('üè† Property type mapping:', {
            original: property.property_type,
            mapped: propertyTypeText,
            property_id: property.id,
            note: '3=Commercial, 20=Residential'
        });
        
        // Get property title (handle multilingual object)
        const title = property.title?.en || property.title || 'Luxury Property';
        
        // Get location from city and district
        const cityName = property.city?.name?.en || property.city?.name || '';
        const districtName = property.district?.name?.en || property.district?.name || '';
        const location = districtName ? `${districtName}, ${cityName}` : cityName || 'Premium Location, Dubai';
        
        // Format price
        const price = property.low_price ? `AED ${property.low_price.toLocaleString()}` : 'Contact for Price';
        
        // Get area
        const area = property.min_area ? `${property.min_area.toLocaleString()} sq ft` : 'N/A';
        
        // Get image - check both 'cover' and 'image' fields
        const image = property.cover || property.image || 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80';
        
        return `
            <div class="property-card">
                <div class="property-image" style="background-image: url('${image}');">
                    <div class="price-tag">
                        Available
                    </div>
                    <div class="property-type-badge">
                        ${propertyTypeText}
                    </div>
                </div>

                <div class="card-body">
                    <h3 class="property-title">${title}</h3>
                    
                    <div class="property-location">
                        <i class="fas fa-map-marker-alt"></i>
                        ${location}
                    </div>

                    <div class="property-features">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="feature-text">${price}</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-ruler-combined"></i>
                            </div>
                            <div class="feature-text">${area}</div>
                        </div>
                    </div>

                    <div class="property-actions">
                        <a href="/property/${property.id}/" class="btn-primary-custom">
                            <i class="fas fa-eye"></i>
                            View Details
                        </a>
                        <a href="{% url 'contact' %}" class="btn-outline-primary">
                            <i class="fas fa-phone"></i>
                            Contact Agent
                        </a>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    propertiesGrid.innerHTML = propertiesHTML;
}

// Global function to update pagination
function updatePagination(data) {
    console.log('üìÑ Updating pagination with data:', data);
    console.log('üìÑ Pagination keys:', Object.keys(data));
    console.log('üìÑ Count:', data.count, 'Current page:', data.current_page, 'Last page:', data.last_page);
    console.log('üìÑ Next URL:', data.next_page_url, 'Prev URL:', data.prev_page_url);
    
    const paginationSection = document.querySelector('.pagination-section');
    if (!paginationSection) {
        console.log('üìÑ No pagination section found');
        return;
    }

    // Check if pagination is needed
    if (!data.next_page_url && !data.prev_page_url) {
        console.log('üìÑ No pagination needed, hiding section');
        paginationSection.style.display = 'none';
        return;
    }

    console.log('üìÑ Showing pagination section');
    paginationSection.style.display = 'block';
    
    // Calculate total pages from the API response
    const totalCount = data.count || 0;
    const perPage = 12; // Assuming 12 items per page, adjust if different
    const totalPages = Math.max(1, Math.ceil(totalCount / perPage));
    const currentPage = Math.max(1, Math.min(data.current_page || 1, totalPages));
    
    console.log('üìÑ Pagination info: Current:', currentPage, 'Total pages:', totalPages);
    
    // Update pagination HTML based on data
    let paginationHTML = '';
    
    // Previous button
    if (data.prev_page_url) {
        paginationHTML += `
            <button type="button" class="nav-btn" onclick="goToPageByUrl('${data.prev_page_url}')">
                <i class="fas fa-chevron-left"></i>
                Previous
            </button>
        `;
    } else {
        paginationHTML += '<span></span>';
    }

    // Add page numbers if needed
    if (totalPages > 1) {
        paginationHTML += '<div class="pagination-nav">';
        
        // Show first few pages
        const maxPagesToShow = 5;
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <button type="button" class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                    ${i}
                </button>
            `;
        }
        
        // Show ellipsis and last page if needed
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += '<span class="page-btn">...</span>';
            }
            paginationHTML += `
                <button type="button" class="page-btn" onclick="goToPage(${totalPages})">
                    ${totalPages}
                </button>
            `;
        }
        
        paginationHTML += '</div>';
    }

    // Next button
    if (data.next_page_url) {
        paginationHTML += `
            <button type="button" class="nav-btn" onclick="goToPageByUrl('${data.next_page_url}')">
                Next
                <i class="fas fa-chevron-right"></i>
            </button>
        `;
    } else {
        paginationHTML += '<span></span>';
    }

    paginationSection.innerHTML = paginationHTML;
}

// Global function to go to page by URL (for next/previous buttons)
function goToPageByUrl(url) {
    console.log('üìÑ Going to page by URL:', url);
    
    // Show loading state
    const searchBtn = document.getElementById('searchBtn');
    const originalText = searchBtn.innerHTML;
    
    searchBtn.classList.add('loading');
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    searchBtn.disabled = true;
    
    // Make direct API call to the external URL
    fetch(url)
    .then(response => response.json())
    .then(result => {
        console.log('üìÑ Direct API response:', result);
        
        if (result.status && result.data) {
            const propertiesData = result.data;
            const properties = propertiesData.results || [];
            
            // Update properties grid
            updatePropertiesGrid(properties);
            
            // Update pagination
            updatePagination(propertiesData);
            
            // Update total count
            updateTotalCount(propertiesData.count || 0);
            
            // Scroll to top of properties section
            const propertiesSection = document.querySelector('.properties-section');
            if (propertiesSection) {
                propertiesSection.scrollIntoView({ behavior: 'smooth' });
            }
        } else {
            console.error('‚ùå Direct API error:', result?.error || 'Unknown error');
            showError('Failed to load page. Please try again.');
        }
    })
    .catch(error => {
        console.error('‚ùå Direct API error:', error);
        showError('An error occurred while loading the page.');
    })
    .finally(() => {
        // Reset button state
        searchBtn.classList.remove('loading');
        searchBtn.innerHTML = originalText;
        searchBtn.disabled = false;
    });
}

// Global function to update total count
function updateTotalCount(count) {
    const totalCountElement = document.querySelector('.total-count strong');
    if (totalCountElement) {
        totalCountElement.textContent = count;
    }
}

// Global function to show error messages
function showError(message) {
    const propertiesSection = document.querySelector('.properties-section');
    if (!propertiesSection) return;

    const errorHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            ${message}
        </div>
    `;

    // Insert error at the top of properties section
    propertiesSection.insertAdjacentHTML('afterbegin', errorHTML);
    
    // Remove error after 5 seconds
    setTimeout(() => {
        const errorAlert = propertiesSection.querySelector('.alert-danger');
        if (errorAlert) {
            errorAlert.remove();
        }
    }, 5000);
}

})(); // End of IIFE

// Global pagination function - must be outside IIFE to be accessible by onclick handlers
function goToPage(page) {
    console.log('üìÑ Going to page:', page);
    
    // Show loading state
    const searchBtn = document.getElementById('searchBtn');
    const originalText = searchBtn.innerHTML;
    
    searchBtn.classList.add('loading');
    searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
    searchBtn.disabled = true;
    
    // Get current form data
    const filterForm = document.querySelector('.filter-form');
    const formData = new FormData(filterForm);
    
    // Make API call with page parameter
    const csrftoken = getCookie('csrftoken');
    const filters = {};
    
    // Convert form data to filters object
    for (let [key, value] of formData.entries()) {
        if (value && value.trim()) {
            filters[key] = value.trim();
        }
    }
    
    // Handle property type conversion
    if (filters.property_type === 'residential') {
        filters.property_type = 'Residential';
    } else if (filters.property_type === 'commercial') {
        filters.property_type = 'Commercial';
    }
    
    // Add page parameter for external API
    filters.page = page;
    
    console.log('üìÑ Sending pagination request with filters:', filters);
    
    fetch('/api/properties/filter/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken,
        },
        body: JSON.stringify(filters)
    })
    .then(response => response.json())
    .then(result => {
        console.log('üìÑ Pagination response:', result);
        
        if (result.status && result.data) {
            const propertiesData = result.data;
            const properties = propertiesData.results || [];
            
            // Update properties grid
            updatePropertiesGrid(properties);
            
            // Update pagination
            updatePagination(propertiesData);
            
            // Update total count
            updateTotalCount(propertiesData.count || 0);
            
            // Scroll to top of properties section
            const propertiesSection = document.querySelector('.properties-section');
            if (propertiesSection) {
                propertiesSection.scrollIntoView({ behavior: 'smooth' });
            }
        } else {
            console.error('‚ùå Pagination API error:', result?.error || 'Unknown error');
            showError('Failed to load page. Please try again.');
        }
    })
    .catch(error => {
        console.error('‚ùå Pagination error:', error);
        showError('An error occurred while loading the page.');
    })
    .finally(() => {
        // Reset button state
        searchBtn.classList.remove('loading');
        searchBtn.innerHTML = originalText;
        searchBtn.disabled = false;
    });
}
</script>
{% endblock %}

{% endblock %}
