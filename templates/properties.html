{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Properties in Dubai - KIF Realty{% endblock %}

{% block description %}Browse a wide range of properties with KIF Realty. Find your dream home or investment opportunity in Dubai's prime locations. Start your property search today{% endblock %}

{% block canonical %}
<link rel="canonical" href="https://kifrealty.com/properties/">
{% endblock %}

<link rel="preconnect" href="https://offplan.market">
<link rel="dns-prefetch" href="https://offplan.market">

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/properties_styles.css' %}">
{% endblock %}

{% block content %}

<!-- Page Header -->
<section class="properties-header">
    <div class="header-content">
        <h1>Signature Collection</h1>
        <p>Discover exceptional real estate opportunities in prime locations</p>
        <div class="total-count">
            <i class="fas fa-gem me-2" aria-hidden="true"></i>
            <strong id="totalCountDisplay">{{ total_count|default:"Loading..." }}</strong> Exclusive Properties Available
        </div>
    </div>
</section>

<!-- Filters Section -->
<section class="filters-section">
    <div class="filters-container">
        <form method="POST" class="filter-form" action="{% url 'properties' %}">
            {% csrf_token %}

            <!-- Property Type Toggle -->
            <div class="property-type-section">
                <label class="filter-label">Property Type</label>
                <div class="property-type-toggle">
                    <button type="button" class="property-type-btn active" data-type="residential" id="residentialBtn">
                        Residential
                    </button>
                    <button type="button" class="property-type-btn" data-type="commercial" id="commercialBtn">
                        Commercial
                    </button>
                </div>
                <input type="hidden" name="property_type" id="propertyTypeInput" value="residential">
            </div>

            <!-- Main Filters Grid -->
            <div class="main-filters">
                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-home filter-icon" aria-hidden="true"></i>
                        Unit Type
                    </label>
                    <select name="unit_type" class="filter-select" id="unitTypeSelect">
                        <option value="">All Types</option>
                        <option value="apartment">Apartment</option>
                        <option value="villa">Villa</option>
                        <option value="townhouse">Townhouse</option>
                        <option value="penthouse">Penthouse</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-map-marker-alt filter-icon" aria-hidden="true"></i>
                        City
                    </label>
                    <select name="city" class="filter-select" id="citySelect">
                        <option value="">All Cities</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-building filter-icon" aria-hidden="true"></i>
                        Neighborhood
                    </label>
                    <select name="district" class="filter-select" id="neighborhoodSelect">
                        <option value="">Select Area</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">
                        <i class="fas fa-dollar-sign filter-icon" aria-hidden="true"></i>
                        Price Range
                    </label>
                    <select name="price_range" class="filter-select" id="priceRangeSelect">
                        <option value="">Any Price</option>
                        <option value="0-1000000" data-min="0" data-max="1000000">Under 1M AED</option>
                        <option value="1000000-2000000" data-min="1000000" data-max="2000000">1M - 2M AED</option>
                        <option value="2000000-5000000" data-min="2000000" data-max="5000000">2M - 5M AED</option>
                        <option value="5000000-10000000" data-min="5000000" data-max="10000000">5M - 10M AED</option>
                        <option value="10000000+" data-min="10000000" data-max="">Above 10M AED</option>
                    </select>
                </div>
            </div>

            <!-- Bedrooms Section (Only for Residential) -->
            <div class="bedrooms-section" id="bedroomsSection">
                <label class="filter-label">
                    <i class="fas fa-bed filter-icon" aria-hidden="true"></i>
                    Bedrooms
                </label>
                <div class="bedrooms-grid">
                    <button type="button" class="bedroom-btn" data-bedrooms="1">1</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="2">2</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="3">3</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="4">4</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="5">5</button>
                    <button type="button" class="bedroom-btn" data-bedrooms="6+">6+</button>
                </div>
                <input type="hidden" name="bedrooms" id="bedroomsInput" value="">
            </div>

            <!-- Advanced Filters Toggle -->
            <div class="advanced-filters-toggle">
                <button type="button" class="advanced-toggle-btn" id="advancedToggle">
                    <i class="fas fa-sliders-h" aria-hidden="true"></i>
                    Advanced Filters
                    <i class="fas fa-chevron-down" id="advancedIcon" aria-hidden="true"></i>
                </button>
            </div>

            <!-- Advanced Filters Content -->
            <div class="advanced-filters-content" id="advancedContent">
                <div class="advanced-filters-grid">
                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-calendar filter-icon" aria-hidden="true"></i>
                            Delivery Year
                        </label>
                        <select name="delivery_year" class="filter-select">
                            <option value="">Any Year</option>
                            <option value="2024">2024</option>
                            <option value="2025">2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                            <option value="2028">2028</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-building filter-icon" aria-hidden="true"></i>
                            Developer
                        </label>
                        <select name="developer" class="filter-select" id="developerSelect">
                            <option value="">All Developers</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-search filter-icon" aria-hidden="true"></i>
                            Project Name
                        </label>
                        <input type="text" name="project_name" class="filter-input" placeholder="Search by project name">
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">
                            <i class="fas fa-tag filter-icon" aria-hidden="true"></i>
                            Property Status
                        </label>
                        <select name="property_status" class="filter-select">
                            <option value="">Any Status</option>
                            <option value="Ready">Ready</option>
                            <option value="Off Plan">Off Plan</option>
                            <option value="Under Construction">Under Construction</option>
                        </select>
                    </div>
                </div>

                <!-- Price Range Sliders -->
                <div class="range-sliders">
                    <div class="range-group">
                        <label class="filter-label">
                            <i class="fas fa-coins filter-icon" aria-hidden="true"></i>
                            Price Range (AED)
                        </label>
                        <div class="range-inputs">
                            <input type="range" id="minPriceRange" min="0" max="100000000" value="0" class="range-slider">
                            <input type="range" id="maxPriceRange" min="0" max="100000000" value="100000000" class="range-slider">
                        </div>
                        <div class="range-display">
                            <span id="minPriceDisplay">0 AED</span>
                            <span id="maxPriceDisplay">100M AED</span>
                        </div>
                        <input type="hidden" name="min_price" id="minPriceInput" value="0">
                        <input type="hidden" name="max_price" id="maxPriceInput" value="100000000">
                    </div>

                    <div class="range-group">
                        <label class="filter-label">
                            <i class="fas fa-ruler-combined filter-icon" aria-hidden="true"></i>
                            Area Range (sq ft)
                        </label>
                        <div class="range-inputs">
                            <input type="range" id="minAreaRange" min="0" max="50000" value="0" class="range-slider">
                            <input type="range" id="maxAreaRange" min="0" max="50000" value="50000" class="range-slider">
                        </div>
                        <div class="range-display">
                            <span id="minAreaDisplay">0 sq ft</span>
                            <span id="maxAreaDisplay">50,000 sq ft</span>
                        </div>
                        <input type="hidden" name="min_area" id="minAreaInput" value="0">
                        <input type="hidden" name="max_area" id="maxAreaInput" value="50000">
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="filter-actions">
                <button type="button" class="reset-btn" onclick="resetFilters()">
                    <i class="fas fa-refresh" aria-hidden="true"></i>
                    Reset Filters
                </button>
                <button type="submit" class="search-btn" id="searchBtn">
                    <i class="fas fa-search" aria-hidden="true"></i>
                    Search Properties
                </button>
            </div>
        </form>
    </div>
</section>

<!-- Properties Grid -->
<section class="properties-section">
    {% if properties_error %}
    <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle" aria-hidden="true"></i>
        {{ properties_error }}
    </div>
    {% endif %}

    <div class="properties-grid">
        <div class="no-properties">
            <div class="no-properties-icon">
                <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
            </div>
            <h4>Loading Properties...</h4>
            <p>Please wait while we fetch the latest properties for you.</p>
        </div>
    </div>

    <!-- Dynamic Pagination -->
    <div class="pagination-section" id="dynamicPagination" style="display: none;"></div>
</section>

{% block extra_js %}
<script>
// ============================================
// PART 1: Helper Functions
// ============================================

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function formatCurrency(num) {
    if (num === 0) return '0 AED';
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M AED';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(0) + 'K AED';
    }
    return num.toLocaleString() + ' AED';
}

function scrollToProperties() {
    const propertiesSection = document.querySelector('.properties-section');
    if (propertiesSection) {
        propertiesSection.scrollIntoView({ behavior: 'smooth' });
    }
}

// ============================================
// PART 2: Main Initialization
// ============================================

(function () {
    if (window.filterSystemInitialized) {
        console.log('‚ö†Ô∏è Filter system already initialized');
        return;
    }

    window.filterSystemInitialized = true;

    document.addEventListener('DOMContentLoaded', function () {
        initializeFilters();
        setupEventListeners();
        loadInitialProperties();
        
        // Load cities and developers after a delay
        setTimeout(() => {
            loadCitiesFromAPI();
            loadDevelopersFromAPI();
        }, 500);
    });

    // ============================================
    // PART 3: Initialize Filters
    // ============================================

    function initializeFilters() {
        const propertyTypeInput = document.getElementById('propertyTypeInput');
        if (propertyTypeInput) {
            propertyTypeInput.value = 'residential';
        }

        updatePropertyType('residential');
        updatePriceRange();
        updateAreaRange();
    }

    // ============================================
    // PART 4: Load Initial Properties (12 only)
    // ============================================

    function loadInitialProperties() {
        console.log('üè† Loading initial 12 properties...');

        const propertiesGrid = document.querySelector('.properties-grid');
        if (propertiesGrid) {
            propertiesGrid.innerHTML = `
                <div class="no-properties">
                    <div class="no-properties-icon">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <h4>Loading Properties...</h4>
                    <p>Please wait...</p>
                </div>
            `;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const cityParam = urlParams.get('city');
        const districtParam = urlParams.get('district');
        
        const filters = {
            property_type: 'Residential',
            limit: 12,
            page: 1
        };

        if (cityParam) filters.city = cityParam;
        if (districtParam) filters.district = districtParam;

        fetch('https://offplan.market/api/properties/filter/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(filters)
        })
        .then(response => response.json())
        .then(result => {
            if (result?.status && result?.data) {
                const propertiesData = result.data;
                const properties = propertiesData.results || [];

                window.updatePropertiesGrid(properties);
                window.updatePagination(propertiesData);
                window.updateTotalCount(propertiesData.count);
            } else {
                window.updatePropertiesGrid([]);
                window.updatePagination({ count: 0, current_page: 1, last_page: 1 });
                window.updateTotalCount(0);
            }
        })
        .catch(error => {
            console.error('‚ùå Error:', error);
            if (propertiesGrid) {
                propertiesGrid.innerHTML = `
                    <div class="no-properties">
                        <div class="no-properties-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h4>Error Loading Properties</h4>
                        <p>Please try refreshing the page.</p>
                    </div>
                `;
            }
        });
    }

    // ============================================
    // PART 5: Event Listeners
    // ============================================

    function setupEventListeners() {
        // Property type buttons
        document.querySelectorAll('.property-type-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                updatePropertyType(this.dataset.type);
            });
        });

        // Bedroom buttons
        document.querySelectorAll('.bedroom-btn').forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);

            newBtn.addEventListener('click', function (e) {
                e.preventDefault();
                updateBedroomSelection(this.dataset.bedrooms);
            });
        });

        // Advanced filters toggle
        const advancedToggle = document.getElementById('advancedToggle');
        if (advancedToggle) {
            advancedToggle.addEventListener('click', function (e) {
                e.preventDefault();
                toggleAdvancedFilters();
            });
        }

        // Form submission
        const filterForm = document.querySelector('.filter-form');
        if (filterForm) {
            filterForm.addEventListener('submit', function (e) {
                e.preventDefault();

                const searchBtn = document.getElementById('searchBtn');
                if (searchBtn.classList.contains('loading')) return;

                const originalText = searchBtn.innerHTML;
                searchBtn.classList.add('loading');
                searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Searching...';
                searchBtn.disabled = true;

                performSearch().finally(() => {
                    searchBtn.classList.remove('loading');
                    searchBtn.innerHTML = originalText;
                    searchBtn.disabled = false;
                });
            });
        }

        // City change
        document.getElementById('citySelect').addEventListener('change', function () {
            updateNeighborhoods(this.value);
        });

        // Range sliders
        const minPriceRange = document.getElementById('minPriceRange');
        const maxPriceRange = document.getElementById('maxPriceRange');
        const minAreaRange = document.getElementById('minAreaRange');
        const maxAreaRange = document.getElementById('maxAreaRange');

        if (minPriceRange) minPriceRange.addEventListener('input', updatePriceRange);
        if (maxPriceRange) maxPriceRange.addEventListener('input', updatePriceRange);
        if (minAreaRange) minAreaRange.addEventListener('input', updateAreaRange);
        if (maxAreaRange) maxAreaRange.addEventListener('input', updateAreaRange);

        // Price range select
        document.getElementById("priceRangeSelect").addEventListener("change", function () {
            const selected = this.options[this.selectedIndex];
            const min = selected.getAttribute("data-min");
            const max = selected.getAttribute("data-max");
            document.getElementById("minPriceInput").value = min || "";
            document.getElementById("maxPriceInput").value = max || "";
        });
    }

    // ============================================
    // PART 6: Update Functions
    // ============================================

    function updatePropertyType(type) {
        const residentialBtn = document.getElementById('residentialBtn');
        const commercialBtn = document.getElementById('commercialBtn');

        if (type === 'residential') {
            residentialBtn.classList.add('active');
            commercialBtn.classList.remove('active');
        } else {
            residentialBtn.classList.remove('active');
            commercialBtn.classList.add('active');
        }

        const propertyTypeInput = document.getElementById('propertyTypeInput');
        if (propertyTypeInput) {
            propertyTypeInput.value = type;
        }

        updateUnitTypeOptions(type);
    }

    function updateUnitTypeOptions(type) {
        const unitTypeSelect = document.getElementById('unitTypeSelect');
        const bedroomsSection = document.getElementById('bedroomsSection');

        if (!unitTypeSelect) return;

        unitTypeSelect.innerHTML = '<option value="">All Types</option>';

        if (type === 'commercial') {
            const options = [
                { value: 'office', text: 'Office' },
                { value: 'shop', text: 'Shop' },
                { value: 'warehouse', text: 'Warehouse' }
            ];

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                unitTypeSelect.appendChild(option);
            });

            if (bedroomsSection) bedroomsSection.style.display = 'none';
        } else {
            const options = [
                { value: 'apartment', text: 'Apartment' },
                { value: 'villa', text: 'Villa' },
                { value: 'townhouse', text: 'Townhouse' },
                { value: 'penthouse', text: 'Penthouse' }
            ];

            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.text;
                unitTypeSelect.appendChild(option);
            });

            if (bedroomsSection) bedroomsSection.style.display = 'block';
        }
    }

    function updateBedroomSelection(bedrooms) {
        document.querySelectorAll('.bedroom-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        const bedroomsInput = document.getElementById('bedroomsInput');
        if (bedroomsInput) {
            if (bedroomsInput.value === bedrooms) {
                bedroomsInput.value = '';
            } else {
                bedroomsInput.value = bedrooms;
                const selectedBtn = document.querySelector(`[data-bedrooms="${bedrooms}"]`);
                if (selectedBtn) selectedBtn.classList.add('active');
            }
        }
    }

    function toggleAdvancedFilters() {
        const content = document.getElementById('advancedContent');
        const icon = document.getElementById('advancedIcon');

        if (!content || !icon) return;

        const isOpen = content.classList.contains('open');

        if (isOpen) {
            content.classList.remove('open');
            content.style.maxHeight = '0px';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        } else {
            content.classList.add('open');
            content.style.maxHeight = '2000px';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        }
    }

    function updatePriceRange() {
        const minRange = document.getElementById('minPriceRange');
        const maxRange = document.getElementById('maxPriceRange');
        const minDisplay = document.getElementById('minPriceDisplay');
        const maxDisplay = document.getElementById('maxPriceDisplay');
        const minInput = document.getElementById('minPriceInput');
        const maxInput = document.getElementById('maxPriceInput');

        if (!minRange || !maxRange) return;

        let minVal = parseInt(minRange.value);
        let maxVal = parseInt(maxRange.value);

        if (minVal >= maxVal) {
            minVal = maxVal - 100000;
            minRange.value = minVal;
        }

        if (minDisplay) minDisplay.textContent = formatCurrency(minVal);
        if (maxDisplay) maxDisplay.textContent = formatCurrency(maxVal);
        if (minInput) minInput.value = minVal;
        if (maxInput) maxInput.value = maxVal;
    }

    function updateAreaRange() {
        const minRange = document.getElementById('minAreaRange');
        const maxRange = document.getElementById('maxAreaRange');
        const minDisplay = document.getElementById('minAreaDisplay');
        const maxDisplay = document.getElementById('maxAreaDisplay');
        const minInput = document.getElementById('minAreaInput');
        const maxInput = document.getElementById('maxAreaInput');

        if (!minRange || !maxRange) return;

        let minVal = parseInt(minRange.value);
        let maxVal = parseInt(maxRange.value);

        if (minVal >= maxVal) {
            minVal = maxVal - 100;
            minRange.value = minVal;
        }

        if (minDisplay) minDisplay.textContent = minVal.toLocaleString() + ' sq ft';
        if (maxDisplay) maxDisplay.textContent = maxVal.toLocaleString() + ' sq ft';
        if (minInput) minInput.value = minVal;
        if (maxInput) maxInput.value = maxVal;
    }

    // ============================================
    // PART 7: Cities and Developers
    // ============================================

    let citiesData = [];
    let developersData = [];

    function loadCitiesFromAPI() {
        fetch('/cities/')
            .then(response => response.json())
            .then(result => {
                if (result?.data?.status && result.data.data) {
                    citiesData = result.data.data;
                    populateCitiesDropdown();
                }
            })
            .catch(error => console.error('Cities error:', error));
    }

    function populateCitiesDropdown() {
        const citySelect = document.getElementById('citySelect');
        if (!citySelect || !citiesData.length) return;

        citySelect.innerHTML = '<option value="">All Cities</option>';

        const uniqueCities = new Map();
        citiesData.forEach(city => {
            if (city.name?.en) {
                uniqueCities.set(city.name.en, city);
            }
        });

        uniqueCities.forEach((city, cityName) => {
            const option = document.createElement('option');
            option.value = cityName;
            option.textContent = cityName;
            citySelect.appendChild(option);
        });
    }

    function loadDevelopersFromAPI() {
        fetch('https://offplan.market/api/developers/')
            .then(response => response.json())
            .then(result => {
                let developers = Array.isArray(result) ? result : result?.data;
                if (developers?.length) {
                    developersData = developers;
                    populateDevelopersDropdown();
                }
            })
            .catch(error => console.error('Developers error:', error));
    }

    function populateDevelopersDropdown() {
        const developerSelect = document.getElementById('developerSelect');
        if (!developerSelect || !developersData.length) return;

        developerSelect.innerHTML = '<option value="">All Developers</option>';

        const uniqueDevelopers = new Map();
        developersData.forEach(dev => {
            const name = dev.name || dev.title || dev;
            if (name) uniqueDevelopers.set(name, dev);
        });

        Array.from(uniqueDevelopers.entries())
            .sort((a, b) => a[0].localeCompare(b[0]))
            .forEach(([name]) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                developerSelect.appendChild(option);
            });
    }

    function updateNeighborhoods(cityName) {
        const neighborhoodSelect = document.getElementById('neighborhoodSelect');
        if (!neighborhoodSelect) return;

        neighborhoodSelect.innerHTML = '<option value="">Select Area</option>';

        if (!cityName || !citiesData.length) return;

        const matchingCities = citiesData.filter(city => city.name?.en === cityName);
        const allDistricts = new Map();

        matchingCities.forEach(city => {
            city.districts?.forEach(district => {
                if (district.name?.en) {
                    allDistricts.set(district.name.en, district);
                }
            });
        });

        Array.from(allDistricts.entries())
            .sort((a, b) => a[0].localeCompare(b[0]))
            .forEach(([name]) => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                neighborhoodSelect.appendChild(option);
            });
    }

    // ============================================
    // PART 8: Search Function
    // ============================================

    function performSearch() {
        const filterForm = document.querySelector('.filter-form');
        const formData = new FormData(filterForm);

        const propertyType = formData.get('property_type') === 'commercial' ? 'Commercial' : 'Residential';

        const filters = {
            property_type: propertyType,
            limit: 12,
            page: 1
        };

        // Add other filters
        const city = formData.get('city');
        if (city?.trim()) filters.city = city.trim();

        const district = formData.get('district');
        if (district?.trim()) filters.district = district.trim();

        const unitType = formData.get('unit_type');
        if (unitType?.trim()) filters.unit_type = unitType.trim();

        if (propertyType === 'Residential') {
            const rooms = formData.get('bedrooms');
            if (rooms?.trim()) filters.rooms = rooms.trim();
        }

        const deliveryYear = formData.get('delivery_year');
        if (deliveryYear && deliveryYear !== '0') {
            filters.delivery_year = parseInt(deliveryYear);
        }

        const minPrice = parseInt(formData.get('min_price')) || 0;
        const maxPrice = parseInt(formData.get('max_price')) || 100000000;
        if (minPrice > 0) filters.low_price = minPrice;
        if (maxPrice < 100000000) filters.max_price = maxPrice;

        const minArea = parseInt(formData.get('min_area')) || 0;
        const maxArea = parseInt(formData.get('max_area')) || 50000;
        if (minArea > 0) filters.min_area = minArea;
        if (maxArea < 50000) filters.max_area = maxArea;

        const title = formData.get('project_name');
        if (title?.trim()) filters.title = title.trim();

        const developer = formData.get('developer');
        if (developer?.trim()) filters.developer = developer.trim();

        const status = formData.get('property_status');
        if (status?.trim() && status !== 'Total') {
            filters.property_status = status.trim();
        }

        return fetch('https://offplan.market/api/properties/filter/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(filters)
        })
        .then(response => response.json())
        .then(result => {
            if (result?.status && result?.data) {
                const propertiesData = result.data;
                const properties = propertiesData.results || [];

                window.updatePropertiesGrid(properties);
                window.updatePagination(propertiesData);
                window.updateTotalCount(propertiesData.count);
            } else {
                window.updatePropertiesGrid([]);
                window.updatePagination({ count: 0, current_page: 1, last_page: 1 });
                window.updateTotalCount(0);
            }
        })
        .catch(error => {
            console.error('‚ùå Search error:', error);
            window.showError('An error occurred while searching');
        });
    }

    // ============================================
    // PART 9: Reset Filters
    // ============================================

    window.resetFilters = function() {
        const filterForm = document.querySelector('.filter-form');
        if (filterForm) filterForm.reset();

        updatePropertyType('residential');

        document.querySelectorAll('.bedroom-btn').forEach(btn => btn.classList.remove('active'));
        const bedroomsInput = document.getElementById('bedroomsInput');
        if (bedroomsInput) bedroomsInput.value = '';

        document.getElementById('minPriceRange').value = 0;
        document.getElementById('maxPriceRange').value = 100000000;
        document.getElementById('minAreaRange').value = 0;
        document.getElementById('maxAreaRange').value = 50000;

        updatePriceRange();
        updateAreaRange();

        const neighborhoodSelect = document.getElementById('neighborhoodSelect');
        if (neighborhoodSelect) {
            neighborhoodSelect.innerHTML = '<option value="">Select Area</option>';
        }

        const content = document.getElementById('advancedContent');
        const icon = document.getElementById('advancedIcon');
        if (content && icon) {
            content.classList.remove('open');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    };

})();

// ============================================
// PART 10: Global Functions (Outside IIFE)
// ============================================

window.updatePropertiesGrid = function (properties) {
    const propertiesGrid = document.querySelector('.properties-grid');
    if (!propertiesGrid) return;

    if (properties.length === 0) {
        propertiesGrid.innerHTML = `
            <div class="no-properties">
                <div class="no-properties-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h4>No Properties Found</h4>
                <p>Try adjusting your search filters.</p>
            </div>
        `;
        return;
    }

    const propertiesHTML = properties.map(property => {
        let propertyTypeText = property.property_type || 'Residential';
        if (propertyTypeText === 3 || propertyTypeText === '3') propertyTypeText = 'Commercial';
        if (propertyTypeText === 20 || propertyTypeText === '20') propertyTypeText = 'Residential';

        const title = property.title?.en || property.title || 'Luxury Property';
        const cityName = property.city?.name?.en || property.city?.name || '';
        const districtName = property.district?.name?.en || property.district?.name || '';
        const location = districtName ? `${districtName}, ${cityName}` : cityName || 'Dubai';
        const price = property.low_price ? `AED ${property.low_price.toLocaleString()}` : 'Contact for Price';
        const area = property.min_area ? `${property.min_area.toLocaleString()} sq ft` : 'N/A';

        const image = property.cover || property.image || 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=300&q=80';
        const optimizedImage = image.includes('?') ? `${image}&w=400&h=300&q=80` : `${image}?w=400&h=300&q=80`;
        
        const slug = property.slug || 'property';
        const propertyUrl = `/property/${slug}-${property.id}/`;

        return `
            <div class="property-card">
                <div class="property-image" style="background-image: url('${optimizedImage}'); background-size: cover;">
                    <div class="price-tag">Available</div>
                    <div class="property-type-badge">${propertyTypeText}</div>
                </div>
                <div class="card-body">
                    <h3 class="property-title">${title}</h3>
                    <div class="property-location">
                        <i class="fas fa-map-marker-alt"></i>
                        ${location}
                    </div>
                    <div class="property-features">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-coins"></i>
                            </div>
                            <div class="feature-text">${price}</div>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-ruler-combined"></i>
                            </div>
                            <div class="feature-text">${area}</div>
                        </div>
                    </div>
                    <div class="property-actions">
                        <a href="${propertyUrl}" class="btn-primary-custom">
                            <i class="fas fa-eye"></i> View Details
                        </a>
                        <a href="/contact/" class="btn-outline-primary">
                            <i class="fas fa-phone"></i> Contact Agent
                        </a>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    propertiesGrid.innerHTML = propertiesHTML;
};

window.updateTotalCount = function (count) {
    const totalCountElement = document.getElementById('totalCountDisplay');
    if (totalCountElement) {
        totalCountElement.textContent = count;
    }
};

window.showError = function (message) {
    const propertiesSection = document.querySelector('.properties-section');
    if (!propertiesSection) return;

    const errorHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            ${message}
        </div>
    `;

    propertiesSection.insertAdjacentHTML('afterbegin', errorHTML);

    setTimeout(() => {
        const errorAlert = propertiesSection.querySelector('.alert-danger');
        if (errorAlert) errorAlert.remove();
    }, 5000);
};

// ============================================
// PART 11: Pagination Functions
// ============================================

window.goToPage = function (page) {
    const searchBtn = document.getElementById('searchBtn');
    if (searchBtn) {
        searchBtn.classList.add('loading');
        searchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        searchBtn.disabled = true;
    }

    const filterForm = document.querySelector('.filter-form');
    const formData = new FormData(filterForm);

    const propertyType = formData.get('property_type') === 'commercial' ? 'Commercial' : 'Residential';
    const filters = { property_type: propertyType, limit: 12 };

    const city = formData.get('city');
    if (city?.trim()) filters.city = city.trim();

    const district = formData.get('district');
    if (district?.trim()) filters.district = district.trim();

    fetch(`https://offplan.market/api/properties/filter/?page=${page}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(filters)
    })
    .then(response => response.json())
    .then(result => {
        if (result?.status && result?.data) {
            const propertiesData = result.data;
            window.updatePropertiesGrid(propertiesData.results || []);
            window.updatePagination(propertiesData);
            window.updateTotalCount(propertiesData.count);
            scrollToProperties();
        }
    })
    .catch(error => {
        console.error('‚ùå Pagination error:', error);
        window.showError('Failed to load page');
    })
    .finally(() => {
        if (searchBtn) {
            searchBtn.classList.remove('loading');
            searchBtn.innerHTML = '<i class="fas fa-search"></i> Search Properties';
            searchBtn.disabled = false;
        }
    });
};

window.updatePagination = function (data) {
    const paginationSection = document.querySelector('#dynamicPagination');
    if (!paginationSection) return;

    const totalCount = data.count || 0;
    const currentPage = data.current_page || 1;
    const nextUrl = data.next_page_url;
    const previousUrl = data.previous_page_url;
    const totalPages = Math.max(1, Math.ceil(totalCount / 12));

    if (totalPages <= 1) {
        paginationSection.style.display = 'none';
        return;
    }

    paginationSection.style.display = 'flex';

    let paginationHTML = '<div class="pagination-nav">';

    // Previous button
    if (previousUrl) {
        paginationHTML += `
            <button type="button" class="nav-btn" onclick="goToPage(${currentPage - 1})">
                <i class="fas fa-chevron-left"></i> Previous
            </button>
        `;
    } else {
        paginationHTML += `<button type="button" class="nav-btn" disabled><i class="fas fa-chevron-left"></i> Previous</button>`;
    }

    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);

    for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
            <button type="button" class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">
                ${i}
            </button>
        `;
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            paginationHTML += '<span class="page-btn">...</span>';
        }
        paginationHTML += `<button type="button" class="page-btn" onclick="goToPage(${totalPages})">${totalPages}</button>`;
    }

    // Next button
    if (nextUrl) {
        paginationHTML += `
            <button type="button" class="nav-btn" onclick="goToPage(${currentPage + 1})">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        `;
    } else {
        paginationHTML += `<button type="button" class="nav-btn" disabled>Next <i class="fas fa-chevron-right"></i></button>`;
    }

    paginationHTML += '</div>';

    if (totalCount > 0) {
        paginationHTML += `
            <div class="pagination-info">
                <span>Page ${currentPage} of ${totalPages} (${totalCount} properties)</span>
            </div>
        `;
    }

    paginationSection.innerHTML = paginationHTML;
};
</script>
{% endblock %}

{% endblock %}